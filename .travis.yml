language: node_js
node_js:
  - "lts/*"

sudo: required

services:
  - docker

#addons:
#  apt:
#    - jq
#    - fakeroot
#    - dpkg
#    - libavahi-compat-libdnssd-dev

jobs:
  include:
    - stage: test
      script:
        - npm test
    - stage: build and push amd64 and arm32v7 images
      script:
        - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
        - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
        - docker build -f Dockerfile -t signalk/signalk-server:linux-amd64-"$BRANCH" .
        - docker push signalk/signalk-server:linux-amd64-"$BRANCH"
    - script:
        - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
        - docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
        - docker run --rm --privileged multiarch/qemu-user-static:register --reset
        - mkdir tmp
        - >
          pushd tmp &&
          curl -L -o qemu-arm-static.tar.gz https://github.com/multiarch/qemu-user-static/releases/download/v2.11.0/qemu-arm-static.tar.gz &&
          tar xzf qemu-arm-static.tar.gz &&
          popd
        - docker build -f Dockerfile_arm32v7 -t signalk/signalk-server:linux-arm32v7-"$BRANCH" .
        - docker push signalk/signalk-server:linux-arm32v7-"$BRANCH"
    - stage: build and push multi-arch manifest
      script:
        - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
        - ./make-manifest.sh
        - docker run --rm -v `pwd`:`pwd` -w `pwd` tkurki/manifest-tool --username="$DOCKER_USER" --password="$DOCKER_PASS" push from-spec docker-manifest.yml


    - stage: build-deb-branch
      before_install:
        - npm install -g node-deb
      script:
        - export PACKAGE_VERSION=$(echo "const data = require('./package.json'); console.log(data.version)" | node)
        - node-deb --verbose -n "signalk-server-${TRAVIS_BRANCH}" -v "${PACKAGE_VERSION}-snapshot-${TRAVIS_BUILD_NUMBER}" -- index.js `find . -maxdepth 1 -type d | grep -v .git | grep -v node_modules | egrep -v '^\.$'`
#        - if [ $TRAVIS_TAG =~ ^v[0-9] ] ; then node-deb --verbose -n "signalk-server" -v "${PACKAGE_VERSION}" -- index.js `find . -maxdepth 1 -type d | grep -v .git | grep -v node_modules | egrep -v '^\.$'`; fi
        - ls -lh *.deb ; dpkg-deb --info *.deb
#      deploy:
#        - provider: packagecloud
#          repository: signalk-server
#          username: SignalK 
#          token:
#            secure:  "t5Pd/vXCntWx1fPL536o8qwHZWcirVEOqH6S2kbKVjeCMsep5jEpipGn/dSFu+pjpkZKbJ2WmRJto6ApNwA/kJZa2SMrzHexGP/dIiwtc3i7MxWqdj0n3u9L2+G8wkUzmuFMoaudgU5AAWuW//CQjXVmdoVN1P+d4cCSqMKd6qCnGWfEiQSlypHji9NfZ85uef2S35XXTHc67VhjtjerKUpd2lj/wY86EcRssr0VGx06I64tjGoRjO0wcQwjIkutEUEadHKUenZ3r8n8WqroeU2+EdbtYlpX6mk6TCFRniZxDVpK1vKkYnsd/EJh5UAVKvMjK9BzYLa+MixNtLAfhJuK5UEQ3FG9PiPJHmt4u4F14it9mseVdMtZs1AwXlYmREnPACXayTZ71+W5CUWhUbeR97wTyVKBGoubcMgI1qvlJMHDDxWKFIa3pYoiuQe+gUVmo3CGpfe9VJifSyRTSW/IRuHW8NIro7skLV4CB6f6yG2n4LrZc7j1MK+wn/q08awtcgqngUQCBkw4HiYhAuqxZbQuOVX4TQZC4MoLKIHbpvFQ/YH4VaquBU4eymEA6VRr7ZGe2bCfCSHcNFrDDYzvvqroO16YyMKg9mxBRIwkR06bD7ZiGHAM/tEOnMpq9GQl/V3hqdeIRo5fMsfAwb9xpiyDeUMdeSW/6Ni5VGc="
#          dist: debian/stretch
#          skip_cleanup: true
#          package_glob: signalk-server*.deb
#          on:
#            all_branches: true
#        - provider: packagecloud
#          repository: signalk-server
#          username: SignalK
#          token:
#            secure:  "t5Pd/vXCntWx1fPL536o8qwHZWcirVEOqH6S2kbKVjeCMsep5jEpipGn/dSFu+pjpkZKbJ2WmRJto6ApNwA/kJZa2SMrzHexGP/dIiwtc3i7MxWqdj0n3u9L2+G8wkUzmuFMoaudgU5AAWuW//CQjXVmdoVN1P+d4cCSqMKd6qCnGWfEiQSlypHji9NfZ85uef2S35XXTHc67VhjtjerKUpd2lj/wY86EcRssr0VGx06I64tjGoRjO0wcQwjIkutEUEadHKUenZ3r8n8WqroeU2+EdbtYlpX6mk6TCFRniZxDVpK1vKkYnsd/EJh5UAVKvMjK9BzYLa+MixNtLAfhJuK5UEQ3FG9PiPJHmt4u4F14it9mseVdMtZs1AwXlYmREnPACXayTZ71+W5CUWhUbeR97wTyVKBGoubcMgI1qvlJMHDDxWKFIa3pYoiuQe+gUVmo3CGpfe9VJifSyRTSW/IRuHW8NIro7skLV4CB6f6yG2n4LrZc7j1MK+wn/q08awtcgqngUQCBkw4HiYhAuqxZbQuOVX4TQZC4MoLKIHbpvFQ/YH4VaquBU4eymEA6VRr7ZGe2bCfCSHcNFrDDYzvvqroO16YyMKg9mxBRIwkR06bD7ZiGHAM/tEOnMpq9GQl/V3hqdeIRo5fMsfAwb9xpiyDeUMdeSW/6Ni5VGc="
#          dist: raspbian/stretch
#          skip_cleanup: true
#          package_glob: signalk-server*.deb
#          on:
#            all_branches: true
